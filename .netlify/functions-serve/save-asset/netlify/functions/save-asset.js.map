{
  "version": 3,
  "sources": ["../../workspace/media-file-manager/netlify/functions/save-asset.js"],
  "sourceRoot": "/tmp/tmp-694-TzcEnX0vTYdC",
  "sourcesContent": ["// Netlify function to save an uploaded asset to Xano and Webflow\nexports.handler = async (event) => {\n  try {\n    // Only accept POST requests\n    if (event.httpMethod !== 'POST') {\n      return { statusCode: 405, body: 'Method Not Allowed' };\n    }\n\n    // Set CORS headers for preflight and actual requests\n    const origin = event.headers.origin || '';\n    const allowedOrigins = (process.env.ALLOW_ORIGIN || '').split(',').map((s) => s.trim()).filter(Boolean);\n    const corsHeaders = {\n      'access-control-allow-origin': allowedOrigins.includes(origin) ? origin : allowedOrigins[0] || '*',\n      'access-control-allow-headers': 'content-type, authorization',\n      'access-control-allow-methods': 'POST, OPTIONS'\n    };\n    if (event.httpMethod === 'OPTIONS') {\n      return { statusCode: 204, headers: corsHeaders, body: '' };\n    }\n\n    const asset = JSON.parse(event.body || '{}');\n    if (!asset?.url || !asset?.publicId) {\n      return { statusCode: 400, headers: corsHeaders, body: 'Missing asset url/publicId' };\n    }\n\n    // ---- Save to Xano ----\n    const xanoBase = process.env.XANO_BASE_URL;\n    const xanoEndpoint = process.env.XANO_ASSETS_ENDPOINT || '/v1/assets';\n    if (!xanoBase) throw new Error('XANO_BASE_URL not set');\n    const xanoHeaders = { 'content-type': 'application/json' };\n    if (process.env.XANO_API_KEY) xanoHeaders['Authorization'] = `Bearer ${process.env.XANO_API_KEY}`;\n\n    const xanoRes = await fetch(`${xanoBase}${xanoEndpoint}`, {\n      method: 'POST',\n      headers: xanoHeaders,\n      body: JSON.stringify({\n        title: asset.title || asset.name,\n        url: asset.url,\n        public_id: asset.publicId,\n        resource_type: asset.type,\n        size: asset.size,\n        width: asset.width || null,\n        height: asset.height || null,\n        duration: asset.duration || null,\n        thumbnail: asset.thumbnail || null,\n        format: asset.format || null,\n        raw: asset.cloudinaryData || null\n      })\n    });\n    if (!xanoRes.ok) {\n      const text = await xanoRes.text();\n      throw new Error(`Xano error ${xanoRes.status}: ${text}`);\n    }\n    const xanoJson = await xanoRes.json();\n\n    // ---- Save to Webflow (optional) ----\n    const wfToken = process.env.WEBFLOW_API_TOKEN;\n    const wfCollection = process.env.WEBFLOW_COLLECTION_ID;\n    if (!wfToken || !wfCollection) {\n      return {\n        statusCode: 200,\n        headers: corsHeaders,\n        body: JSON.stringify({ ok: true, xano: xanoJson, webflow: 'skipped' })\n      };\n    }\n    // Build Webflow item payload; adapt field names to your collection schema\n    const itemPayload = {\n      name: asset.title || asset.name,\n      slug: (asset.title || asset.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),\n      _archived: false,\n      _draft: String(process.env.WEBFLOW_DRAFT || 'false') === 'true',\n      url: asset.url,\n      publicId: asset.publicId,\n      type: asset.type,\n      size: asset.size,\n      width: asset.width || null,\n      height: asset.height || null,\n      duration: asset.duration || null,\n      format: asset.format || null,\n      thumbnail: asset.thumbnail || null\n    };\n    const wfHeaders = {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${wfToken}`,\n      'accept-version': '1.0.0'\n    };\n    const wfRes = await fetch(`https://api.webflow.com/collections/${wfCollection}/items`, {\n      method: 'POST',\n      headers: wfHeaders,\n      body: JSON.stringify({ fields: itemPayload })\n    });\n    if (!wfRes.ok) {\n      const t = await wfRes.text();\n      throw new Error(`Webflow error ${wfRes.status}: ${t}`);\n    }\n    const wfJson = await wfRes.json();\n    // Optionally publish; requires WEBFLOW_SITE_ID\n    if (String(process.env.WEBFLOW_PUBLISH || 'false') === 'true') {\n      const siteId = process.env.WEBFLOW_SITE_ID;\n      if (siteId) {\n        try {\n          await fetch(`https://api.webflow.com/sites/${siteId}/publish`, {\n            method: 'POST',\n            headers: wfHeaders,\n            body: JSON.stringify({ publishToDevelopment: true, publishToPreview: true, publishToLive: true })\n          });\n        } catch (e) {\n          console.warn('Webflow publish failed:', e);\n        }\n      }\n    }\n    return {\n      statusCode: 200,\n      headers: corsHeaders,\n      body: JSON.stringify({ ok: true, xano: xanoJson, webflow: wfJson })\n    };\n  } catch (err) {\n    const msg = err instanceof Error ? err.message : String(err);\n    return { statusCode: 500, body: msg };\n  }\n};\n"],
  "mappings": "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",
  "names": []
}
